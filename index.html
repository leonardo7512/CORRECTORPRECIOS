<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corrector de Pedidos Pro v37.0 (Lote por NV)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #1a1d23; --bg-secondary: #242832; --bg-accent: #2d3748;
            --text-primary: #e2e8f0; --text-secondary: #a0aec0; --accent-green: #48bb78;
            --accent-blue: #4299e1; --border-color: #4a5568; --accent-purple: #9f7aea;
        }
        body { font-family: 'Courier Prime', monospace; background-color: var(--bg-primary); color: var(--text-primary); }
        .panel { background-color: var(--bg-secondary); } 
        .input-field { background-color: var(--bg-accent); border: 1px solid var(--border-color); color: var(--text-primary); transition: border-color 0.2s ease; }
        .input-field:focus { border-color: var(--accent-green); box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.2); outline: none; }
        .disabled-section, button:disabled { opacity: 0.5; cursor: not-allowed; }
        .highlight-cell { border: 2px solid #f59e0b !important; font-weight: 700; }
        .image-preview { max-width: 150px; max-height: 150px; border-radius: 8px; border: 2px solid var(--border-color); }
        .progress-bar { width: 100%; height: 20px; background-color: var(--bg-accent); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-blue), var(--accent-green)); transition: width 0.3s ease; }
        .nv-card { border-left: 4px solid var(--accent-purple); background-color: var(--bg-accent); margin-bottom: 2rem; }
        .nv-header { background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue)); padding: 1rem; border-radius: 8px 8px 0 0; }
        .nv-badge { display: inline-block; background-color: var(--accent-green); color: var(--bg-primary); padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold">Corrector de Pedidos Profesional</h1>
            <p class="text-secondary mt-2">Versi√≥n 37.0 - Procesamiento por Lotes (Separado por NV)</p>
        </header>

        <div id="ocr-section" class="panel p-6 rounded-lg shadow-md mb-8 disabled-section">
            <h2 class="text-xl font-semibold mb-4">üì∏ Escanear Notas de Venta por Lotes</h2>
            <div class="bg-blue-900 bg-opacity-30 border border-blue-500 rounded-lg p-4 mb-4">
                <p class="text-sm"><strong>üí° Instrucciones:</strong></p>
                <ul class="text-sm mt-2 ml-4 list-disc">
                    <li>Sube m√∫ltiples fotos de notas de venta</li>
                    <li>El sistema detectar√° el <strong>N¬∞ de Nota</strong> en cada imagen</li>
                    <li>Cada nota ser√° procesada y corregida <strong>individualmente</strong></li>
                </ul>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Subir im√°genes de notas (JPG, PNG)</label>
                <input type="file" id="image-upload" accept="image/*" multiple class="input-field w-full p-2 rounded-md">
            </div>
            <div id="ocr-progress" class="hidden mb-4">
                <p class="text-sm mb-2">Procesando: <span id="ocr-current">0</span> de <span id="ocr-total">0</span></p>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
            <div id="image-previews" class="grid grid-cols-3 md:grid-cols-6 gap-4 mb-4"></div>
            <button id="btn-process-images" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-md hover:bg-purple-700" disabled>
                üîç Procesar Todas las Notas con OCR
            </button>
        </div>

        <div id="debug-section" class="panel p-4 rounded-lg shadow-md mb-8">
            <h3 class="text-lg font-semibold mb-2">üîß Log de Procesamiento</h3>
            <div id="debug-info" class="text-sm max-h-60 overflow-y-auto">
                <p>El an√°lisis de las notas aparecer√° aqu√≠...</p>
            </div>
        </div>

        <div id="upload-section" class="panel p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4">Estado del Cat√°logo</h2>
            <div id="status-container">
                <p id="loading-status" class="text-lg" style="color: #f59e0b;">üîÑ Cargando cat√°logo desde GitHub...</p>
                <p id="catalog-version" class="text-sm text-secondary mt-2"></p>
                <button id="btn-refresh-catalog" class="hidden mt-4 bg-blue-600 text-white font-bold py-1 px-3 rounded-md hover:bg-blue-700 text-sm">
                    Refrescar Cat√°logo
                </button>
            </div>
        </div>

        <div id="notas-procesadas-container" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">üìã Notas de Venta Procesadas</h2>
                <button id="btn-copiar-resumen-general" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700">
                    üìÑ Copiar Resumen General
                </button>
            </div>
            <div id="notas-list"></div>
        </div>
    </div>

<script>
    const CATALOG_URL = 'https://raw.githubusercontent.com/leonardo7512/CORRECTORPRECIOS/main/2708CATALOGO_ACTUALIZADO3.csv';
    let catalogoCompleto = [];
    let notasProcesadas = [];
    let ui = {};

    // ========== FUNCIONES OCR ==========
    async function processImagesWithOCR(files) {
        const totalFiles = files.length;
        ui.ocrProgress.classList.remove('hidden');
        ui.ocrTotal.textContent = totalFiles;
        notasProcesadas = [];
        
        for (let i = 0; i < files.length; i++) {
            ui.ocrCurrent.textContent = i + 1;
            ui.progressFill.style.width = `${((i + 1) / totalFiles) * 100}%`;
            
            try {
                const file = files[i];
                const text = await extractTextFromImage(file);
                const numeroNota = extractNotaVenta(text);
                const esNeto = detectarTipoPrecio(text);
                const productos = parseOCRText(text);
                
                if (productos.length > 0) {
                    notasProcesadas.push({
                        nv: numeroNota,
                        productos: productos,
                        esNeto: esNeto,
                        textoOriginal: text
                    });
                    ui.debugInfo.innerHTML += `<p class="text-green-400">‚úì NV ${numeroNota}: ${productos.length} productos | ${esNeto ? 'NETOS' : 'BRUTOS'}</p>`;
                } else {
                    ui.debugInfo.innerHTML += `<p class="text-yellow-400">‚ö†Ô∏è NV ${numeroNota}: Sin productos</p>`;
                }
            } catch (error) {
                ui.debugInfo.innerHTML += `<p class="text-red-400">‚úó Error imagen ${i + 1}: ${error.message}</p>`;
            }
        }
        
        if (notasProcesadas.length > 0) {
            ui.debugInfo.innerHTML += `<p class="text-green-400 font-bold">‚úÖ ${notasProcesadas.length} notas procesadas</p>`;
            procesarTodasLasNotas();
        } else {
            ui.debugInfo.innerHTML += `<p class="text-red-400">‚ùå No se pudieron extraer notas</p>`;
        }
        
        ui.ocrProgress.classList.add('hidden');
    }

    async function extractTextFromImage(file) {
        const { data: { text } } = await Tesseract.recognize(file, 'spa', {
            logger: m => { if (m.status === 'recognizing text') console.log(`OCR: ${Math.round(m.progress * 100)}%`); }
        });
        return text;
    }

    function extractNotaVenta(text) {
        const patterns = [
            /N[¬∞¬∫]\s*(\d{5,6})/i,
            /NOTA\s*VENTA\s*N[¬∞¬∫]?\s*(\d{5,6})/i,
            /NV\s*[:-]?\s*(\d{5,6})/i
        ];
        for (const pattern of patterns) {
            const match = text.match(pattern);
            if (match) return match[1];
        }
        return 'Sin NV';
    }

    function detectarTipoPrecio(text) {
        const textoNormalizado = text.toLowerCase();
        const tieneIVA = textoNormalizado.includes('i.v.a') || textoNormalizado.includes('iva');
        const tieneNeto = textoNormalizado.includes('neto');
        return tieneNeto && tieneIVA;
    }

    function parseOCRText(text) {
        const productos = [];
        const lineas = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        
        for (let i = 0; i < lineas.length; i++) {
            const linea = lineas[i];
            const patterns = [
                /^(FC\d{4,5})\s+(.+?)\s+(\d+)\s+\$?\s?([\d.,]+)$/i,
                /(FC\d{4,5})\s+([A-Z\s]+.*?)\s+(\d+)\s+\$?\s?([\d.,]+)/i
            ];
            
            for (const pattern of patterns) {
                const match = linea.match(pattern);
                if (match) {
                    const sku = normalizarSKU(match[1]);
                    let descripcion = match[2].trim().replace(/LATAS?|SANI|AIR|BOTELLA|SKU|ITEM|CANTIDAD/gi, '').trim();
                    const cantidad = parseInt(match[3], 10);
                    const precio = limpiarValor(match[4]);
                    
                    if (sku && cantidad > 0 && precio !== null) {
                        productos.push({
                            sku: sku,
                            item: descripcion || 'Sin descripci√≥n',
                            cantidad: cantidad,
                            v_unitario_usuario: precio
                        });
                        break;
                    }
                }
            }
        }
        return productos;
    }

    // ========== PROCESAMIENTO POR NOTAS ==========
    function procesarTodasLasNotas() {
        const tipoCliente = 'normal';
        const agrupar = true;
        
        notasProcesadas.forEach(nota => {
            const cantidadesPorCategoria = calcularCantidadesPorCategoria(nota.productos);
            nota.resultados = nota.productos.map(item => 
                corregirUnItem(item, tipoCliente, nota.esNeto, cantidadesPorCategoria, agrupar)
            );
            nota.diferenciaTotalNota = nota.resultados.reduce((sum, r) => sum + (r.diferencia_total_linea || 0), 0);
        });
        
        renderNotasProcesadas();
    }

    function renderNotasProcesadas() {
        ui.notasProcesadasContainer.classList.remove('hidden');
        const formatter = new Intl.NumberFormat('es-CL', {style: 'currency', currency: 'CLP'});
        let html = '';
        
        notasProcesadas.forEach((nota, index) => {
            const diferencias = nota.resultados.filter(r => r.highlight === true);
            const colorDiferencia = nota.diferenciaTotalNota > 0 ? 'text-orange-400' : 
                                    nota.diferenciaTotalNota < 0 ? 'text-red-400' : 'text-green-400';
            
            html += `
                <div class="nv-card rounded-lg overflow-hidden mb-8">
                    <div class="nv-header">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-2xl font-bold">Nota de Venta N¬∞ ${nota.nv}</h3>
                                <p class="text-sm mt-1 opacity-90">${nota.productos.length} productos | ${nota.esNeto ? 'NETOS' : 'BRUTOS'}</p>
                            </div>
                            <div class="text-right">
                                ${diferencias.length > 0 ? `<span class="nv-badge bg-red-600">${diferencias.length} Diferencias</span>` : '<span class="nv-badge">‚úì OK</span>'}
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="overflow-x-auto mb-4">
                            <table class="min-w-full">
                                <thead style="background-color:rgba(45,55,72,0.5);">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">SKU</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">Item</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">Cant.</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">Tu Precio</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">Estado</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">Precio Correcto</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">Dif. Unitaria</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">Dif. Total</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            
            nota.resultados.forEach(producto => {
                const diferencia = producto.diferencia !== null ? (producto.diferencia > 0 ? '+' : '') + formatter.format(producto.diferencia) : 'N/A';
                const difTotal = producto.diferencia_total_linea !== null ? (producto.diferencia_total_linea > 0 ? '+' : '') + formatter.format(producto.diferencia_total_linea) : 'N/A';
                
                html += `<tr class="${producto.colorClass}" style="border-bottom:1px solid var(--border-color);">
                    <td class="px-4 py-3 font-medium">${producto.sku}</td>
                    <td class="px-4 py-3">${producto.descripcion}</td>
                    <td class="px-4 py-3">${producto.cantidad}</td>
                    <td class="px-4 py-3">${formatter.format(producto.v_unitario_usuario)}</td>
                    <td class="px-4 py-3 font-semibold">${producto.estado}</td>
                    <td class="px-4 py-3 ${producto.highlight ? 'highlight-cell' : ''}">${producto.precioCorrecto ? formatter.format(producto.precioCorrecto) : 'N/A'}</td>
                    <td class="px-4 py-3">${diferencia}</td>
                    <td class="px-4 py-3 font-bold">${difTotal}</td>
                </tr>`;
            });
            
            html += `</tbody></table></div>
                        <div class="flex justify-between items-center mt-4 pt-4" style="border-top: 1px solid var(--border-color);">
                            <p class="text-lg ${colorDiferencia}"><strong>Diferencia Total NV ${nota.nv}:</strong> ${(nota.diferenciaTotalNota > 0 ? '+' : '') + formatter.format(nota.diferenciaTotalNota)}</p>
                            <button class="btn-copiar-nv bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700" data-index="${index}">üìã Copiar NV ${nota.nv}</button>
                        </div>
                    </div>
                </div>`;
        });
        
        ui.notasList.innerHTML = html;
        document.querySelectorAll('.btn-copiar-nv').forEach(btn => {
            btn.addEventListener('click', (e) => copiarResumenNota(parseInt(e.target.dataset.index)));
        });
    }

    function copiarResumenNota(index) {
        const nota = notasProcesadas[index];
        const f = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
        const diferencias = nota.resultados.filter(r => r.highlight === true);
        
        let texto = `*Nota de Venta N¬∞ ${nota.nv}*\nPrecios: ${nota.esNeto ? 'NETOS' : 'BRUTOS'}\n\n`;
        if (diferencias.length > 0) {
            texto += `*DIFERENCIAS (${diferencias.length})*\n\n`;
            texto += diferencias.map(r => `${r.sku} | Tu: ${f.format(r.v_unitario_usuario)} | Correcto: ${f.format(r.precioCorrecto)} | Dif: ${f.format(r.diferencia)}`).join('\n');
            texto += `\n\n*Diferencia Total NV ${nota.nv}: ${f.format(nota.diferenciaTotalNota)}*`;
        } else {
            texto += `‚úÖ *TODOS LOS PRECIOS CORRECTOS*`;
        }
        
        navigator.clipboard.writeText(texto).then(() => {
            const btn = event.target;
            const orig = btn.textContent;
            btn.textContent = '‚úÖ ¬°Copiado!';
            setTimeout(() => btn.textContent = orig, 2000);
        });
    }

    function copiarResumenGeneral() {
        const f = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
        let texto = `*RESUMEN GENERAL*\nNotas: ${notasProcesadas.length}\n\n`;
        let totalDiferenciasGeneral = 0;
        
        notasProcesadas.forEach(nota => {
            const diferencias = nota.resultados.filter(r => r.highlight === true);
            totalDiferenciasGeneral += nota.diferenciaTotalNota;
            texto += `--- NV ${nota.nv} ---\nProductos: ${nota.productos.length} | Dif: ${diferencias.length}\nTotal: ${f.format(nota.diferenciaTotalNota)}\n\n`;
        });
        
        texto += `\n*DIFERENCIA TOTAL: ${f.format(totalDiferenciasGeneral)}*`;
        navigator.clipboard.writeText(texto).then(() => {
            const btn = ui.btnCopiarResumenGeneral;
            const orig = btn.textContent;
            btn.textContent = '‚úÖ ¬°Copiado!';
            setTimeout(() => btn.textContent = orig, 2500);
        });
    }

    // ========== CAT√ÅLOGO ==========
    async function loadCatalogFromGitHub() {
        ui.btnRefreshCatalog.disabled = true;
        const statusEl = document.getElementById('loading-status');
        const versionEl = document.getElementById('catalog-version');
        statusEl.textContent = 'üîÑ Cargando...';
        statusEl.style.color = '#f59e0b';
        
        try {
            const response = await fetch(`${CATALOG_URL}?v=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`Error: ${response.statusText}`);
            
            const lastModified = response.headers.get('Last-Modified');
            if (lastModified) versionEl.textContent = `üóìÔ∏è ${new Date(lastModified).toLocaleString('es-CL')}`;
            
            const csvText = await response.text();
            Papa.parse(csvText, {
                delimiter: ";",
                skipEmptyLines: true,
                complete: (results) => {
                    catalogoCompleto = procesarCatalogo(results.data.slice(1));
                    statusEl.textContent = `‚úÖ ${catalogoCompleto.length} productos`;
                    statusEl.style.color = 'var(--accent-green)';
                    ui.ocrSection.classList.remove('disabled-section');
                    ui.debugInfo.innerHTML = `<p>Listo. Sube las fotos.</p>`;
                }
            });
        } catch (error) {
            statusEl.innerText = `‚ùå Error`;
            statusEl.style.color = '#ef4444';
        } finally {
            ui.btnRefreshCatalog.classList.remove('hidden');
            ui.btnRefreshCatalog.disabled = false;
        }
    }

    function normalizarSKU(s) { 
        if (!s) return ""; 
        return String(s).toUpperCase().replace(/\s+/g, "").replace(/[^A-Z0-9-]/g, ""); 
    }

    function limpiarValor(v) { 
        if (typeof v === 'number') return v; 
        if (typeof v !== 'string' || v.trim() === '') return null; 
        try { 
            let cleanStr = String(v).replace(/[$\s]/g, '').replace(/,/g, '.');
            return parseFloat(cleanStr); 
        } catch (e) { 
            return null; 
        } 
    }

    function procesarCatalogo(data) { 
        return data.map(row => { 
            if (row.length < 5) return null; 
            return { 
                sku: normalizarSKU(row[0]), 
                descripcion: String(row[1]).trim(), 
                tipo_precio: String(row[2]).trim(), 
                precio_neto: limpiarValor(row[3]), 
                precio_bruto: limpiarValor(row[4]) 
            } 
        }).filter(item => item && item.sku);
    }

    function getCategoriaPrecios(d) { 
        const match = String(d).trim().match(/(.*?)\s*-\s*/); 
        return (match && match[1]) ? match[1].trim() : "General"; 
    }

    function calcularCantidadesPorCategoria(productos) { 
        const c = {}; 
        productos.forEach(i => { 
            const pr = catalogoCompleto.find(p => p.sku === i.sku); 
            const d = pr ? pr.descripcion : i.item || ""; 
            const cat = getCategoriaPrecios(d);
            c[cat] = (c[cat] || 0) + i.cantidad;
        }); 
        return c;
    }

    function obtenerMejorPrecio(sku, tipoCliente, _, cantidadTotalCategoria) { 
        const preciosProducto = catalogoCompleto.filter(p => p.sku === sku); 
        if (preciosProducto.length === 0) return { p: null, t: "NO ENCONTRADO" }; 
        if (preciosProducto.length === 1) { 
            return { p: { n: preciosProducto[0].precio_neto, b: preciosProducto[0].precio_bruto }, t: preciosProducto[0].tipo_precio }; 
        } 
        
        const tramosConMinimo = preciosProducto.map(p => {
            const tipo = (p.tipo_precio || '').toUpperCase();
            let minCantidad = 0;
            const matchNumero = tipo.match(/(\d+)/);
            if (matchNumero) {
                minCantidad = parseInt(matchNumero[1], 10);
            } else if (tipo.includes('DETALLE')) {
                minCantidad = 1;
            } else if (tipo.includes('MAYOR')) {
                minCantidad = 2;
            }
            return { ...p, minCantidad };
        });
        
        const tramosAplicables = tramosConMinimo.filter(p => cantidadTotalCategoria >= p.minCantidad);
        if (tramosAplicables.length > 0) {
            const mejorTramo = tramosAplicables.reduce((mejor, actual) => actual.minCantidad > mejor.minCantidad ? actual : mejor);
            return { p: { n: mejorTramo.precio_neto, b: mejorTramo.precio_bruto }, t: mejorTramo.tipo_precio };
        }
        
        return { p: { n: preciosProducto[0].precio_neto, b: preciosProducto[0].precio_bruto }, t: preciosProducto[0].tipo_precio };
    }

    function corregirUnItem(i, t, n, c, agrupar) { 
        const r = {...i};
        const pr = catalogoCompleto.find(p => p.sku === r.sku); 
        r.descripcion = pr ? pr.descripcion : "No encontrada"; 
        const ca = getCategoriaPrecios(r.descripcion); 
        const ct = agrupar ? (c[ca] || r.cantidad) : r.cantidad; 
        const rp = obtenerMejorPrecio(r.sku, t, r.cantidad, ct); 
        
        let e = "", cl = "", pc = null, d = null, dt = 0, h = false; 
        const colorClasses = {
            ok: 'bg-green-800 bg-opacity-20', 
            aviso: 'bg-orange-800 bg-opacity-20', 
            error: 'bg-red-800 bg-opacity-20', 
            no_encontrado: 'bg-yellow-800 bg-opacity-20'
        }; 
        
        if (!rp.p) { 
            e = rp.t; 
            cl = colorClasses.no_encontrado; 
        } else { 
            pc = n ? rp.p.n : rp.p.b; 
            if (!pc || pc <= 0) { 
                e = "PRECIO NO DISPONIBLE"; 
                cl = colorClasses.no_encontrado;
            } else { 
                d = r.v_unitario_usuario - pc; 
                dt = d * r.cantidad; 
                if (Math.abs(d) < 1.5) { 
                    e = `‚úÖ OK`; 
                    cl = colorClasses.ok;
                } else { 
                    h = true; 
                    e = d > 0 ? `‚ö†Ô∏è AVISO` : `‚ùå ERROR`; 
                    cl = d > 0 ? colorClasses.aviso : colorClasses.error;
                } 
            } 
        } 
        
        return { ...r, estado: e, colorClass: cl, precioCorrecto: pc, diferencia: d, diferencia_total_linea: dt, highlight: h, categoria: ca, cantidadCategoria: ct, tipoAplicado: rp.t };
    }

    // ========== INICIALIZACI√ìN ==========
    document.addEventListener('DOMContentLoaded', () => {
        Object.assign(ui, {
            ocrSection: document.getElementById('ocr-section'),
            imageUpload: document.getElementById('image-upload'),
            btnProcessImages: document.getElementById('btn-process-images'),
            imagePreviews: document.getElementById('image-previews'),
            ocrProgress: document.getElementById('ocr-progress'),
            ocrCurrent: document.getElementById('ocr-current'),
            ocrTotal: document.getElementById('ocr-total'),
            progressFill: document.getElementById('progress-fill'),
            btnRefreshCatalog: document.getElementById('btn-refresh-catalog'),
            debugInfo: document.getElementById('debug-info'),
            notasProcesadasContainer: document.getElementById('notas-procesadas-container'),
            notasList: document.getElementById('notas-list'),
            btnCopiarResumenGeneral: document.getElementById('btn-copiar-resumen-general')
        });

        ui.imageUpload.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            ui.imagePreviews.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'relative text-center';
                    div.innerHTML = `
                        <img src="${e.target.result}" class="image-preview mx-auto" alt="Preview ${index + 1}">
                        <p class="text-xs mt-1 truncate">${file.name}</p>
                    `;
                    ui.imagePreviews.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
            
            ui.btnProcessImages.disabled = files.length === 0;
        });

        ui.btnProcessImages.addEventListener('click', async () => {
            const files = Array.from(ui.imageUpload.files);
            if (files.length === 0) return;
            
            ui.btnProcessImages.disabled = true;
            ui.btnProcessImages.textContent = '‚è≥ Procesando...';
            ui.debugInfo.innerHTML = '<p class="text-yellow-400">üîç Iniciando OCR...</p>';
            ui.notasProcesadasContainer.classList.add('hidden');
            
            try {
                await processImagesWithOCR(files);
            } catch (error) {
                ui.debugInfo.innerHTML += `<p class="text-red-400">‚ùå Error: ${error.message}</p>`;
            } finally {
                ui.btnProcessImages.disabled = false;
                ui.btnProcessImages.textContent = 'üîç Procesar Todas las Notas con OCR';
            }
        });

        ui.btnRefreshCatalog.addEventListener('click', loadCatalogFromGitHub);
        ui.btnCopiarResumenGeneral.addEventListener('click', copiarResumenGeneral);

        loadCatalogFromGitHub();
    });
</script>
</body>
</html>
