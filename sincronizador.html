<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sincronizador Inteligente de Cat√°logo v2.0 - AROMAKER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-primary: #1a1d23;
            --bg-secondary: #242832;
            --bg-accent: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --accent-green: #48bb78;
            --accent-blue: #4299e1;
            --accent-orange: #ed8936;
            --accent-red: #f56565;
            --accent-purple: #9f7aea;
            --border-color: #4a5568;
        }
        body {
            font-family: 'Courier Prime', monospace;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .panel {
            background-color: var(--bg-secondary);
        }
        .input-field {
            background-color: var(--bg-accent);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .badge-nuevo { background-color: var(--accent-green); }
        .badge-actualizado { background-color: var(--accent-blue); }
        .badge-error { background-color: var(--accent-red); }
        .badge-warning { background-color: var(--accent-orange); }
        .badge-info { background-color: var(--accent-purple); }
        .familia-card {
            background-color: var(--bg-accent);
            border-left: 4px solid var(--accent-purple);
            transition: all 0.2s ease;
        }
        .familia-card:hover {
            border-left-color: var(--accent-green);
            background-color: rgba(72, 187, 120, 0.1);
        }
        .error-critical { border-left: 4px solid var(--accent-red); }
        .error-warning { border-left: 4px solid var(--accent-orange); }
        .error-info { border-left: 4px solid var(--accent-blue); }
        .prefix-badge {
            background-color: var(--accent-purple);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .similarity-bar {
            height: 4px;
            background-color: var(--accent-green);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="p-4">
    <div class="container mx-auto max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">üîÑ Sincronizador Inteligente v2.0</h1>
            <p class="text-secondary">Drive ‚Üí Git | Validaci√≥n Avanzada | Reportes Detallados</p>
        </header>

        <!-- Paso 1: Cargar Archivos -->
        <div class="panel p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold mb-4">üìÅ Paso 1: Cargar Archivos</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">
                        Cat√°logo Git (Estructura Base):
                    </label>
                    <input type="file" id="file-git" accept=".csv" 
                           class="input-field w-full p-2 rounded-md text-sm">
                    <p class="text-xs text-secondary mt-1">GIT2708CATALOGO_ACTUALIZADO3.csv</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">
                        Cat√°logo Drive (Fuente de Datos):
                    </label>
                    <input type="file" id="file-drive" accept=".csv" 
                           class="input-field w-full p-2 rounded-md text-sm">
                    <p class="text-xs text-secondary mt-1">DRIVECATALAGO_AROMAKER.csv</p>
                </div>
            </div>
            <button id="btn-analizar" disabled
                    class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                üîç Analizar Diferencias y Validar
            </button>
        </div>

        <!-- Paso 2: Validaci√≥n y Errores -->
        <div id="panel-validacion" class="panel p-6 rounded-lg shadow-md mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4">‚ö†Ô∏è Paso 2: Validaci√≥n y Errores</h2>
            
            <!-- Resumen de Validaci√≥n -->
            <div id="resumen-validacion" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>

            <!-- Tabs de Categor√≠as de Errores -->
            <div class="flex gap-2 mb-4 flex-wrap">
                <button class="tab-error active px-4 py-2 rounded font-semibold" data-tipo="todos" style="background-color: var(--accent-blue);">
                    üìä Todos
                </button>
                <button class="tab-error px-4 py-2 rounded" data-tipo="criticos" style="background-color: rgba(245, 101, 101, 0.2);">
                    ‚ùå Cr√≠ticos
                </button>
                <button class="tab-error px-4 py-2 rounded" data-tipo="advertencias" style="background-color: rgba(237, 137, 54, 0.2);">
                    ‚ö†Ô∏è Advertencias
                </button>
                <button class="tab-error px-4 py-2 rounded" data-tipo="sugerencias" style="background-color: rgba(159, 122, 234, 0.2);">
                    üí° Sugerencias
                </button>
            </div>

            <!-- Lista de Errores Categorizados -->
            <div id="lista-errores" class="max-h-96 overflow-y-auto space-y-2">
                <p class="text-secondary">Los errores y validaciones aparecer√°n aqu√≠...</p>
            </div>
        </div>



        <!-- Paso 3: Vista Previa de Cambios -->
        <div id="panel-cambios" class="panel p-6 rounded-lg shadow-md mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4">üìä Paso 3: Revisi√≥n Detallada de Cambios</h2>
            
            <!-- Resumen -->
            <div id="resumen-cambios" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6"></div>

            <!-- Filtros -->
            <div class="flex gap-2 mb-4 flex-wrap">
                <button class="filtro-btn px-3 py-1 rounded text-sm font-semibold bg-blue-600" data-tipo="todos">
                    Todos
                </button>
                <button class="filtro-btn px-3 py-1 rounded text-sm" data-tipo="nuevos">
                    Nuevos
                </button>
                <button class="filtro-btn px-3 py-1 rounded text-sm" data-tipo="actualizados">
                    Actualizados
                </button>
            </div>

            <!-- B√∫squeda -->
            <input type="text" id="buscar-cambios" placeholder="üîç Buscar por SKU o descripci√≥n..."
                   class="input-field w-full p-2 rounded-md mb-4">

            <!-- Lista de Cambios -->
            <div id="lista-cambios" class="max-h-96 overflow-y-auto">
                <p class="text-secondary">Los cambios aparecer√°n aqu√≠...</p>
            </div>
        </div>

        <!-- Paso 4: Vista Previa del CSV y Prefijos -->
        <div id="panel-preview" class="panel p-6 rounded-lg shadow-md mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4">üëÅÔ∏è Paso 4: Vista Previa y Prefijos</h2>
            
            <div class="bg-accent p-4 rounded-lg mb-4">
                <h3 class="font-semibold mb-2">üí° Informaci√≥n:</h3>
                <ul class="text-sm space-y-1 list-disc list-inside">
                    <li>Aqu√≠ puedes ver TODOS los productos que ir√°n al CSV final</li>
                    <li>Los productos <span class="text-green-400 font-semibold">NUEVOS</span> pueden recibir prefijos</li>
                    <li>Los productos <span class="text-blue-400 font-semibold">ACTUALIZADOS</span> mantienen su SKU</li>
                    <li>Click en cualquier producto NUEVO para agregarle prefijo</li>
                </ul>
            </div>

            <!-- Filtros de vista previa -->
            <div class="flex gap-2 mb-4 flex-wrap items-center">
                <button class="filtro-preview px-3 py-2 rounded text-sm font-semibold bg-blue-600" data-tipo="todos">
                    üìä Todos
                </button>
                <button class="filtro-preview px-3 py-2 rounded text-sm" data-tipo="nuevos">
                    üÜï Solo Nuevos
                </button>
                <button class="filtro-preview px-3 py-2 rounded text-sm" data-tipo="git-originales">
                    üìã Git Originales
                </button>
                <button class="filtro-preview px-3 py-2 rounded text-sm" data-tipo="con-prefijo">
                    üè∑Ô∏è Con Prefijo
                </button>
                
                <input type="text" id="buscar-preview" placeholder="üîç Buscar SKU..."
                       class="input-field ml-auto p-2 rounded-md text-sm" style="width: 250px;">
            </div>

            <!-- Estad√≠sticas de vista previa -->
            <div id="stats-preview" class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4"></div>

            <!-- Lista de productos con vista previa -->
            <div id="lista-preview" class="max-h-96 overflow-y-auto border border-gray-600 rounded-lg p-3">
                <p class="text-secondary">La vista previa aparecer√° aqu√≠...</p>
            </div>

            <div class="mt-4 flex gap-3">
                <button id="btn-limpiar-prefijos" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">
                    üóëÔ∏è Limpiar Todos los Prefijos
                </button>
                <button id="btn-aplicar-prefijo-masivo" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md">
                    üè∑Ô∏è Aplicar Prefijo a M√∫ltiples
                </button>
            </div>
        </div>

        <!-- Paso 5: Generar Cat√°logo -->
        <div id="panel-generar" class="panel p-6 rounded-lg shadow-md hidden">
            <h2 class="text-2xl font-semibold mb-4">üíæ Paso 5: Generar Cat√°logo Actualizado</h2>
            
            <div class="bg-accent p-4 rounded-lg mb-4">
                <h3 class="font-semibold mb-2">‚úÖ Verificaci√≥n Final:</h3>
                <ul class="text-sm space-y-1 list-disc list-inside" id="checklist-final">
                    <li>Estructura Git preservada (delimitador ;)</li>
                    <li>Formato: SKU;DESCRIPCION;TIPO_PRECIO;PRECIO_NETO;PRECIO_BRUTO</li>
                    <li>Compatible con el Corrector de Pedidos</li>
                </ul>
            </div>

            <div id="estadisticas-finales" class="mb-4 p-3 rounded" style="background-color: rgba(72, 187, 120, 0.1); border: 1px solid var(--accent-green);">
            </div>

            <button id="btn-generar" 
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md">
                ‚úÖ Generar CSV Actualizado para Git
            </button>
        </div>

        <!-- Log de Proceso -->
        <div class="panel p-4 rounded-lg shadow-md mt-6">
            <h3 class="text-lg font-semibold mb-2">üìù Log de Proceso</h3>
            <div id="log-proceso" class="text-sm max-h-48 overflow-y-auto bg-accent p-3 rounded">
                <p class="text-secondary">El log aparecer√° aqu√≠...</p>
            </div>
        </div>
    </div>

    <!-- Modal para agregar prefijo -->
    <div id="modal-prefijo" style="display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center;">
        <div class="panel" style="padding: 20px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 8px; position: relative;">
            <span id="modal-prefijo-close" style="color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            
            <h3 class="text-xl font-semibold mb-4">üè∑Ô∏è Agregar Prefijo a SKU</h3>
            
            <div class="mb-4">
                <div class="text-sm text-secondary mb-2">SKU Original:</div>
                <div id="modal-sku-original" class="font-bold text-lg text-blue-300 mb-3"></div>
                
                <div id="modal-descripcion" class="text-sm text-secondary mb-4"></div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Prefijo (ej: RP-, LT-, etc.):</label>
                <input type="text" id="input-prefijo" 
                       class="input-field w-full p-3 rounded-md text-lg font-bold" 
                       placeholder="XX-"
                       maxlength="10">
                <p class="text-xs text-secondary mt-1">Escribe solo las letras y el gui√≥n. Ej: RP-</p>
            </div>

            <div class="mb-4 p-3 rounded-lg" style="background-color: rgba(72, 187, 120, 0.1); border: 1px solid var(--accent-green);">
                <div class="text-sm font-semibold mb-1">Vista previa:</div>
                <div id="preview-sku-final" class="text-lg font-bold text-green-400"></div>
            </div>

            <div class="flex gap-2">
                <button id="btn-aplicar-prefijo-modal" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md">
                    ‚úÖ Aplicar Prefijo
                </button>
                <button id="btn-quitar-prefijo-modal" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-md">
                    üóëÔ∏è Quitar Prefijo
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para prefijo masivo -->
    <div id="modal-prefijo-masivo" style="display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center;">
        <div class="panel" style="padding: 20px; border: 1px solid var(--border-color); width: 90%; max-width: 600px; border-radius: 8px; position: relative; max-height: 80vh; overflow-y: auto;">
            <span id="modal-masivo-close" style="color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            
            <h3 class="text-xl font-semibold mb-4">üè∑Ô∏è Aplicar Prefijo a M√∫ltiples Productos</h3>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Prefijo a aplicar:</label>
                <input type="text" id="input-prefijo-masivo" 
                       class="input-field w-full p-3 rounded-md text-lg font-bold mb-3" 
                       placeholder="XX-"
                       maxlength="10">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Selecciona productos (solo NUEVOS):</label>
                <div id="lista-productos-masivo" class="max-h-96 overflow-y-auto border border-gray-600 rounded p-2">
                </div>
            </div>

            <button id="btn-aplicar-masivo" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md">
                ‚úÖ Aplicar a Seleccionados
            </button>
        </div>
    </div>

    <script>
        let catalogoGit = [];
        let catalogoDrive = [];
        let cambiosDetectados = [];
        let erroresDetectados = [];
        let filtroActivo = 'todos';
        let tabErrorActiva = 'todos';
        let prefijosAplicados = {}; // { skuOriginal: skuConPrefijo }
        let csvPreview = []; // Vista previa del CSV final
        let filtroPreview = 'todos';
        let skuModalActual = null;

        const ui = {
            fileGit: document.getElementById('file-git'),
            fileDrive: document.getElementById('file-drive'),
            btnAnalizar: document.getElementById('btn-analizar'),
            btnGenerar: document.getElementById('btn-generar'),
            panelValidacion: document.getElementById('panel-validacion'),
            panelFamilias: document.getElementById('panel-familias'),
            panelCambios: document.getElementById('panel-cambios'),
            panelGenerar: document.getElementById('panel-generar'),
            resumenValidacion: document.getElementById('resumen-validacion'),
            listaErrores: document.getElementById('lista-errores'),
            listaFamilias: document.getElementById('lista-familias'),
            resumenCambios: document.getElementById('resumen-cambios'),
            listaCambios: document.getElementById('lista-cambios'),
            buscarCambios: document.getElementById('buscar-cambios'),
            logProceso: document.getElementById('log-proceso'),
            checklistFinal: document.getElementById('checklist-final'),
            estadisticasFinales: document.getElementById('estadisticas-finales'),
            // Panel de vista previa
            panelPreview: document.getElementById('panel-preview'),
            listaPreview: document.getElementById('lista-preview'),
            statsPreview: document.getElementById('stats-preview'),
            buscarPreview: document.getElementById('buscar-preview'),
            btnLimpiarPrefijos: document.getElementById('btn-limpiar-prefijos'),
            btnAplicarPrefijoMasivo: document.getElementById('btn-aplicar-prefijo-masivo'),
            // Modal prefijo individual
            modalPrefijo: document.getElementById('modal-prefijo'),
            modalPrefijoClose: document.getElementById('modal-prefijo-close'),
            modalSkuOriginal: document.getElementById('modal-sku-original'),
            modalDescripcion: document.getElementById('modal-descripcion'),
            inputPrefijo: document.getElementById('input-prefijo'),
            previewSkuFinal: document.getElementById('preview-sku-final'),
            btnAplicarPrefijoModal: document.getElementById('btn-aplicar-prefijo-modal'),
            btnQuitarPrefijoModal: document.getElementById('btn-quitar-prefijo-modal'),
            // Modal prefijo masivo
            modalPrefijoMasivo: document.getElementById('modal-prefijo-masivo'),
            modalMasivoClose: document.getElementById('modal-masivo-close'),
            inputPrefijoMasivo: document.getElementById('input-prefijo-masivo'),
            listaProductosMasivo: document.getElementById('lista-productos-masivo'),
            btnAplicarMasivo: document.getElementById('btn-aplicar-masivo')
        };

        // ========== UTILIDADES ==========
        function log(mensaje, tipo = 'info') {
            const colores = {
                info: 'text-blue-400',
                success: 'text-green-400',
                warning: 'text-orange-400',
                error: 'text-red-400'
            };
            const timestamp = new Date().toLocaleTimeString();
            ui.logProceso.innerHTML += `<p class="${colores[tipo]}">[${timestamp}] ${mensaje}</p>`;
            ui.logProceso.scrollTop = ui.logProceso.scrollHeight;
        }

        function normalizarSKU(sku) {
            if (!sku) return '';
            return String(sku).toUpperCase().trim().replace(/\s+/g, '');
        }

        function limpiarPrecio(precio) {
            if (typeof precio === 'number') return precio;
            if (!precio || precio === '') return 0;
            
            const str = String(precio).trim();
            
            if (str.includes('Inf a MM') || 
                str.includes('#VALUE!') || 
                str.includes('PRECIOS VARIABLES') ||
                str.includes('ML') ||
                str.startsWith('üîπ') ||
                str.includes('Caja') ||
                isNaN(parseFloat(str.replace(/[^0-9.,]/g, '')))) {
                return 0;
            }

            try {
                let cleanStr = str.replace(/[$\s]/g, '');
                const lastDot = cleanStr.lastIndexOf('.');
                const lastComma = cleanStr.lastIndexOf(',');
                
                if (lastComma > lastDot) {
                    return parseFloat(cleanStr.replace(/\./g, '').replace(',', '.'));
                }
                if (lastDot > lastComma) {
                    const parts = cleanStr.split('.');
                    if (parts.length > 1 && parts[parts.length - 1].length !== 3) {
                        return parseFloat(cleanStr);
                    }
                    return parseFloat(cleanStr.replace(/\./g, ''));
                }
                return parseFloat(cleanStr);
            } catch (e) {
                return 0;
            }
        }

        function calcularSimilitud(str1, str2) {
            const s1 = str1.toLowerCase().replace(/[^a-z0-9]/g, '');
            const s2 = str2.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            if (s1 === s2) return 100;
            
            let matches = 0;
            const len = Math.min(s1.length, s2.length);
            
            for (let i = 0; i < len; i++) {
                if (s1[i] === s2[i]) matches++;
            }
            
            return Math.round((matches / Math.max(s1.length, s2.length)) * 100);
        }

        // ========== PROCESADORES CSV ==========
        function procesarCatalogoGit(data) {
            log('Procesando cat√°logo Git...', 'info');
            const productos = [];
            
            data.forEach((row, index) => {
                if (index === 0 || row.length < 5) return;
                
                const sku = normalizarSKU(row[0]);
                if (!sku) return;

                productos.push({
                    sku: sku,
                    descripcion: row[1] ? String(row[1]).trim() : '',
                    tipo_precio: row[2] ? String(row[2]).trim() : '',
                    precio_neto: limpiarPrecio(row[3]),
                    precio_bruto: limpiarPrecio(row[4]),
                    linea_original: row
                });
            });

            log(`‚úÖ Git: ${productos.length} registros cargados`, 'success');
            return productos;
        }

        function procesarCatalogoDrive(data) {
            log('Procesando cat√°logo Drive...', 'info');
            const productos = [];
            
            data.forEach((row, index) => {
                if (index === 0 || row.length < 6) return;
                
                const sku = normalizarSKU(row[1]);
                if (!sku || sku === 'NA') return;

                const descripcion = row[0] ? String(row[0]).trim() : '';
                const precioDetalleBruto = limpiarPrecio(row[2]);
                const precioDetalleNeto = limpiarPrecio(row[3]);
                const precioMayorBruto = limpiarPrecio(row[4]);
                const precioMayorNeto = limpiarPrecio(row[5]);
                const observaciones = row[6] ? String(row[6]).trim() : '';

                let tipoMayor = 'MAYOR 6 UN.';
                if (observaciones.includes('MAYOR DESDE 3')) {
                    tipoMayor = 'MAYOR 3 UN.';
                } else if (observaciones.includes('MAYOR DESDE 2')) {
                    tipoMayor = 'MAYOR 2 UN.';
                }

                productos.push({
                    sku: sku,
                    descripcion: descripcion,
                    precios: [
                        {
                            tipo: 'DETALLE',
                            neto: precioDetalleNeto,
                            bruto: precioDetalleBruto
                        },
                        {
                            tipo: tipoMayor,
                            neto: precioMayorNeto,
                            bruto: precioMayorBruto
                        }
                    ],
                    observaciones: observaciones,
                    tiene_precio_unico: observaciones.includes('PRECIO UNICO')
                });
            });

            log(`‚úÖ Drive: ${productos.length} productos cargados`, 'success');
            return productos;
        }

        // ========== VALIDADOR ==========
        function validarCatalogos() {
            log('Validando cat√°logos...', 'info');
            const errores = [];

            // Validar duplicados en Git
            const skusGit = {};
            catalogoGit.forEach(p => {
                const key = `${p.sku}_${p.tipo_precio}`;
                if (skusGit[key]) {
                    errores.push({
                        tipo: 'critico',
                        titulo: 'SKU Duplicado en Git',
                        mensaje: `${p.sku} tiene m√∫ltiples entradas para ${p.tipo_precio}`,
                        sku: p.sku,
                        icono: '‚ùå'
                    });
                }
                skusGit[key] = true;
            });

            // Validar precios inconsistentes
            cambiosDetectados.forEach(cambio => {
                if (cambio.tipo === 'actualizado') {
                    cambio.cambiosPrecios.forEach(cp => {
                        const difNeto = Math.abs(cp.netoDespues - cp.netoAntes);
                        const difBruto = Math.abs(cp.brutoDespues - cp.brutoAntes);
                        
                        if (difNeto > cp.netoAntes * 0.5 || difBruto > cp.brutoAntes * 0.5) {
                            errores.push({
                                tipo: 'advertencia',
                                titulo: 'Cambio de Precio Grande',
                                mensaje: `${cambio.sku}: Cambio >50% en ${cp.lista}`,
                                sku: cambio.sku,
                                icono: '‚ö†Ô∏è',
                                detalle: `Neto: ${cp.netoAntes} ‚Üí ${cp.netoDespues} | Bruto: ${cp.brutoAntes} ‚Üí ${cp.brutoDespues}`
                            });
                        }
                    });
                }
            });

            // Validar productos sin precio
            const sinPrecio = cambiosDetectados.filter(c => c.preciosPendientes);
            if (sinPrecio.length > 0) {
                errores.push({
                    tipo: 'advertencia',
                    titulo: 'Productos Sin Precio',
                    mensaje: `${sinPrecio.length} productos se agregar√°n con precio $0`,
                    icono: '‚ö†Ô∏è',
                    detalle: `SKUs: ${sinPrecio.map(p => p.sku).join(', ')}`
                });
            }

            log(`‚úÖ Validaci√≥n completada: ${errores.length} alertas`, errores.length > 0 ? 'warning' : 'success');
            return errores;
        }

        // ========== COMPARADOR ==========
        function analizarDiferencias() {
            log('Analizando diferencias...', 'info');
            const cambios = [];
            const skusGit = new Set(catalogoGit.map(p => p.sku));
            const skusDrive = new Set(catalogoDrive.map(p => p.sku));

            catalogoDrive.forEach(prodDrive => {
                if (!skusGit.has(prodDrive.sku)) {
                    const tienePrecios = prodDrive.precios.some(p => p.neto > 0 || p.bruto > 0);
                    
                    cambios.push({
                        tipo: 'nuevo',
                        sku: prodDrive.sku,
                        descripcion: prodDrive.descripcion,
                        preciosPendientes: !tienePrecios,
                        detalle: tienePrecios ? 
                            'Producto nuevo con precios' : 
                            'Producto nuevo SIN precios (se agregar√° con $0)',
                        drive: prodDrive
                    });
                }
            });

            catalogoDrive.forEach(prodDrive => {
                if (skusGit.has(prodDrive.sku)) {
                    const registrosGit = catalogoGit.filter(p => p.sku === prodDrive.sku);
                    let hayActualizacion = false;
                    let detalles = [];

                    prodDrive.precios.forEach(precioDrive => {
                        const registroGit = registrosGit.find(r => 
                            r.tipo_precio === precioDrive.tipo || 
                            (precioDrive.tipo.includes('MAYOR') && r.tipo_precio.includes('MAYOR'))
                        );

                        if (registroGit) {
                            const cambioNeto = Math.abs(registroGit.precio_neto - precioDrive.neto) > 1;
                            const cambioBruto = Math.abs(registroGit.precio_bruto - precioDrive.bruto) > 1;

                            if (cambioNeto || cambioBruto) {
                                hayActualizacion = true;
                                detalles.push({
                                    lista: precioDrive.tipo,
                                    netoAntes: registroGit.precio_neto,
                                    netoDespues: precioDrive.neto,
                                    brutoAntes: registroGit.precio_bruto,
                                    brutoDespues: precioDrive.bruto
                                });
                            }
                        }
                    });

                    if (hayActualizacion) {
                        cambios.push({
                            tipo: 'actualizado',
                            sku: prodDrive.sku,
                            descripcion: prodDrive.descripcion,
                            detalle: `${detalles.length} precio(s) actualizados`,
                            cambiosPrecios: detalles,
                            drive: prodDrive
                        });
                    }
                }
            });

            log(`‚úÖ An√°lisis completado: ${cambios.length} cambios detectados`, 'success');
            log(`  - Nuevos: ${cambios.filter(c => c.tipo === 'nuevo').length}`, 'info');
            log(`  - Actualizados: ${cambios.filter(c => c.tipo === 'actualizado').length}`, 'info');
            
            return cambios;
        }

        // ========== RENDERIZADORES ==========
        function renderResumenValidacion() {
            const criticos = erroresDetectados.filter(e => e.tipo === 'critico').length;
            const advertencias = erroresDetectados.filter(e => e.tipo === 'advertencia').length;
            const sugerencias = erroresDetectados.filter(e => e.tipo === 'sugerencia').length;
            const total = erroresDetectados.length;

            ui.resumenValidacion.innerHTML = `
                <div class="badge-error text-white p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold">${criticos}</div>
                    <div class="text-sm">Cr√≠ticos</div>
                </div>
                <div class="badge-warning text-white p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold">${advertencias}</div>
                    <div class="text-sm">Advertencias</div>
                </div>
                <div class="badge-info text-white p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold">${sugerencias}</div>
                    <div class="text-sm">Sugerencias</div>
                </div>
                <div class="bg-accent text-white p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold">${total}</div>
                    <div class="text-sm">Total</div>
                </div>
            `;
        }

        function renderErrores(filtro = 'todos') {
            let erroresFiltrados = erroresDetectados;

            if (filtro !== 'todos') {
                erroresFiltrados = erroresDetectados.filter(e => {
                    if (filtro === 'criticos') return e.tipo === 'critico';
                    if (filtro === 'advertencias') return e.tipo === 'advertencia';
                    if (filtro === 'sugerencias') return e.tipo === 'sugerencia';
                    return true;
                });
            }

            if (erroresFiltrados.length === 0) {
                ui.listaErrores.innerHTML = '<p class="text-secondary text-center py-8">‚úÖ No hay errores de este tipo</p>';
                return;
            }

            let html = '';
            erroresFiltrados.forEach(error => {
                const claseError = `error-${error.tipo === 'critico' ? 'critical' : error.tipo === 'advertencia' ? 'warning' : 'info'}`;
                
                html += `
                    <div class="bg-accent p-3 rounded-lg ${claseError}">
                        <div class="flex items-start gap-2">
                            <span class="text-xl">${error.icono}</span>
                            <div class="flex-1">
                                <div class="font-semibold">${error.titulo}</div>
                                <div class="text-sm text-secondary">${error.mensaje}</div>
                                ${error.detalle ? `<div class="text-xs text-secondary mt-1">${error.detalle}</div>` : ''}
                                ${error.sku ? `<div class="text-xs text-purple-400 mt-1">SKU: ${error.sku}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            ui.listaErrores.innerHTML = html;
        }

        function renderFamilias() {
            if (familiasDetectadas.length === 0) {
                ui.listaFamilias.innerHTML = '<p class="text-secondary text-center py-8">‚úÖ No se detectaron familias (o todos los productos ya est√°n en Git)</p>';
                return;
            }

            let html = '';
            familiasDetectadas.forEach((familia, index) => {
                const similitudPromedio = Math.round(
                    familia.productos.reduce((sum, p, i) => {
                        if (i === 0) return 0;
                        return sum + calcularSimilitud(p.descripcion, familia.productos[0].descripcion);
                    }, 0) / (familia.productos.length - 1)
                );

                html += `
                    <div class="familia-card p-4 rounded-lg">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="font-semibold text-lg mb-1">
                                    Familia ${index + 1}: ${familia.palabrasClave.join(' + ')}
                                </div>
                                <div class="text-xs text-secondary">
                                    ${familia.productos.length} productos | Similitud: ${similitudPromedio}%
                                </div>
                                <div class="mt-1">
                                    <div style="width: ${similitudPromedio}%; background-color: var(--accent-green); height: 4px; border-radius: 2px;"></div>
                                </div>
                            </div>
                            <div>
                                <span class="prefix-badge">${familia.prefijoSugerido}</span>
                            </div>
                        </div>

                        <div class="space-y-1 mb-3">
                            ${familia.productos.map(p => `
                                <div class="text-sm bg-primary p-2 rounded">
                                    <span class="text-purple-400 font-semibold">${p.sku}</span> - ${p.descripcion}
                                </div>
                            `).join('')}
                        </div>

                        <div class="flex gap-2">
                            <input type="text" 
                                   class="input-field flex-1 p-2 rounded text-sm" 
                                   value="${familia.prefijoSugerido}" 
                                   id="prefijo-${index}"
                                   placeholder="Prefijo personalizado">
                            <button class="btn-aplicar-prefijo bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-semibold"
                                    data-familia-index="${index}">
                                ‚úì Aplicar
                            </button>
                            <button class="btn-ignorar-familia bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm"
                                    data-familia-index="${index}">
                                Ignorar
                            </button>
                        </div>
                    </div>
                `;
            });

            ui.listaFamilias.innerHTML = html;

            // Event listeners para botones de familias
            document.querySelectorAll('.btn-aplicar-prefijo').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.familiaIndex);
                    const prefijo = document.getElementById(`prefijo-${index}`).value.trim();
                    aplicarPrefijoFamilia(index, prefijo);
                });
            });

            document.querySelectorAll('.btn-ignorar-familia').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.familiaIndex);
                    ignorarFamilia(index);
                });
            });
        }

        function aplicarPrefijoFamilia(index, prefijo) {
            const familia = familiasDetectadas[index];
            
            familia.productos.forEach(producto => {
                const cambio = cambiosDetectados.find(c => c.sku === producto.sku);
                if (cambio && !cambio.sku.startsWith(prefijo)) {
                    prefijosAplicados[cambio.sku] = prefijo + cambio.sku;
                    log(`‚úÖ Prefijo aplicado: ${cambio.sku} ‚Üí ${prefijosAplicados[cambio.sku]}`, 'success');
                }
            });

            familiasDetectadas.splice(index, 1);
            renderFamilias();
            renderCambios(filtroActivo);
            
            log(`‚úÖ Familia procesada con prefijo: ${prefijo}`, 'success');
        }

        function ignorarFamilia(index) {
            familiasDetectadas.splice(index, 1);
            renderFamilias();
            log(`‚ÑπÔ∏è Familia ignorada`, 'info');
        }

        function renderResumenCambios() {
            const nuevos = cambiosDetectados.filter(c => c.tipo === 'nuevo').length;
            const actualizados = cambiosDetectados.filter(c => c.tipo === 'actualizado').length;
            const advertencias = cambiosDetectados.filter(c => c.preciosPendientes).length;
            const conPrecios = cambiosDetectados.filter(c => c.tipo === 'nuevo' && !c.preciosPendientes).length;

            ui.resumenCambios.innerHTML = `
                <div class="badge-nuevo text-white p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold">${nuevos}</div>
                    <div class="text-sm">Nuevos</div>
                </div>
                <div class="badge-actualizado text-white p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold">${actualizados}</div>
                    <div class="text-sm">Actualizados</div>
                </div>
                <div class="badge-warning text-white p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold">${advertencias}</div>
                    <div class="text-sm">Sin Precios</div>
                </div>
                <div class="badge-info text-white p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold">${conPrecios}</div>
                    <div class="text-sm">Con Precios</div>
                </div>
                <div class="bg-accent text-white p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold">${catalogoGit.length + nuevos}</div>
                    <div class="text-sm">Total Final</div>
                </div>
            `;
        }

        function renderCambios(filtro = 'todos', busqueda = '') {
            let cambiosFiltrados = cambiosDetectados;

            if (filtro !== 'todos') {
                if (filtro === 'nuevos') {
                    cambiosFiltrados = cambiosFiltrados.filter(c => c.tipo === 'nuevo');
                } else if (filtro === 'actualizados') {
                    cambiosFiltrados = cambiosFiltrados.filter(c => c.tipo === 'actualizado');
                }
            }

            if (busqueda) {
                const termino = busqueda.toLowerCase();
                cambiosFiltrados = cambiosFiltrados.filter(c => 
                    c.sku.toLowerCase().includes(termino) || 
                    c.descripcion.toLowerCase().includes(termino)
                );
            }

            const formatter = new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                maximumFractionDigits: 0
            });

            let html = '<div class="space-y-3">';
            cambiosFiltrados.forEach(cambio => {
                const badgeClass = cambio.tipo === 'nuevo' ? 'badge-nuevo' : 'badge-actualizado';
                const iconoAdvertencia = cambio.preciosPendientes ? ' ‚ö†Ô∏è' : '';

                html += `
                    <div class="bg-accent p-4 rounded-lg border-l-4 ${cambio.tipo === 'nuevo' ? 'border-green-500' : 'border-blue-500'}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <span class="${badgeClass} text-white text-xs px-2 py-1 rounded font-semibold mr-2">
                                    ${cambio.tipo.toUpperCase()}${iconoAdvertencia}
                                </span>
                                <span class="font-bold text-blue-300 text-lg">${cambio.sku}</span>
                            </div>
                        </div>
                        <p class="text-sm mb-3 font-medium">${cambio.descripcion}</p>
                `;

                // üÜï Informaci√≥n detallada para NUEVOS
                if (cambio.tipo === 'nuevo') {
                    html += '<div class="bg-primary p-3 rounded mb-2">';
                    html += '<div class="text-xs font-semibold text-green-400 mb-2">üì¶ INFORMACI√ìN DEL NUEVO PRODUCTO:</div>';
                    
                    if (cambio.drive && cambio.drive.precios) {
                        html += '<div class="grid grid-cols-2 gap-2 text-xs">';
                        cambio.drive.precios.forEach(precio => {
                            const tienePrecios = precio.neto > 0 || precio.bruto > 0;
                            html += `
                                <div class="bg-accent p-2 rounded ${!tienePrecios ? 'border border-orange-500' : ''}">
                                    <div class="font-semibold text-purple-400">${precio.tipo}</div>
                                    <div class="${tienePrecios ? 'text-green-400' : 'text-orange-400'}">
                                        Neto: ${tienePrecios ? formatter.format(precio.neto) : 'SIN PRECIO'}
                                    </div>
                                    <div class="${tienePrecios ? 'text-green-400' : 'text-orange-400'}">
                                        Bruto: ${tienePrecios ? formatter.format(precio.bruto) : 'SIN PRECIO'}
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    if (cambio.preciosPendientes) {
                        html += '<div class="mt-2 text-xs text-orange-400 font-semibold">‚ö†Ô∏è Este producto se agregar√° con precio $0 - actualizar precios posteriormente</div>';
                    } else {
                        html += '<div class="mt-2 text-xs text-green-400 font-semibold">‚úÖ Producto listo para agregar con precios</div>';
                    }
                    
                    html += '</div>';
                }

                // üÜï Informaci√≥n detallada para ACTUALIZADOS
                if (cambio.cambiosPrecios && cambio.cambiosPrecios.length > 0) {
                    html += '<div class="bg-primary p-3 rounded">';
                    html += '<div class="text-xs font-semibold text-blue-400 mb-2">üîÑ CAMBIOS DE PRECIO DETECTADOS:</div>';
                    html += '<div class="space-y-2">';
                    
                    cambio.cambiosPrecios.forEach(cp => {
                        const difNeto = cp.netoDespues - cp.netoAntes;
                        const difBruto = cp.brutoDespues - cp.brutoAntes;
                        const pctNeto = ((difNeto / cp.netoAntes) * 100).toFixed(1);
                        const pctBruto = ((difBruto / cp.brutoAntes) * 100).toFixed(1);
                        
                        const colorNeto = difNeto > 0 ? 'text-green-400' : 'text-red-400';
                        const colorBruto = difBruto > 0 ? 'text-green-400' : 'text-red-400';
                        const iconoNeto = difNeto > 0 ? '‚Üó' : '‚Üò';
                        const iconoBruto = difBruto > 0 ? '‚Üó' : '‚Üò';
                        
                        html += `
                            <div class="bg-accent p-2 rounded text-xs">
                                <div class="font-semibold text-purple-400 mb-1">${cp.lista}</div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <div class="text-secondary mb-1">Precio Neto:</div>
                                        <div class="flex justify-between items-center">
                                            <span>${formatter.format(cp.netoAntes)}</span>
                                            <span class="${colorNeto} font-bold">${iconoNeto}</span>
                                            <span class="font-bold">${formatter.format(cp.netoDespues)}</span>
                                        </div>
                                        <div class="${colorNeto} text-xs">(${difNeto > 0 ? '+' : ''}${pctNeto}%)</div>
                                    </div>
                                    <div>
                                        <div class="text-secondary mb-1">Precio Bruto:</div>
                                        <div class="flex justify-between items-center">
                                            <span>${formatter.format(cp.brutoAntes)}</span>
                                            <span class="${colorBruto} font-bold">${iconoBruto}</span>
                                            <span class="font-bold">${formatter.format(cp.brutoDespues)}</span>
                                        </div>
                                        <div class="${colorBruto} text-xs">(${difBruto > 0 ? '+' : ''}${pctBruto}%)</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }

                html += '</div>';
            });
            html += '</div>';

            ui.listaCambios.innerHTML = cambiosFiltrados.length > 0 ? 
                html : 
                '<p class="text-secondary text-center py-8">No hay cambios que mostrar con este filtro</p>';
        }

        // ========== GENERADOR DE VISTA PREVIA ==========
        function generarVistaPrevia() {
            log('Generando vista previa del CSV...', 'info');
            csvPreview = [];

            // 1. Copiar todos los productos Git existentes
            catalogoGit.forEach(productoGit => {
                csvPreview.push({
                    sku: productoGit.sku,
                    descripcion: productoGit.descripcion,
                    tipo_precio: productoGit.tipo_precio,
                    precio_neto: productoGit.precio_neto,
                    precio_bruto: productoGit.precio_bruto,
                    origen: 'git',
                    actualizado: false
                });
            });

            // 2. Actualizar precios de productos existentes
            cambiosDetectados.forEach(cambio => {
                if (cambio.tipo === 'actualizado') {
                    cambio.drive.precios.forEach(precioDrive => {
                        const index = csvPreview.findIndex(p => 
                            p.sku === cambio.sku && 
                            (p.tipo_precio === precioDrive.tipo || 
                             (precioDrive.tipo.includes('MAYOR') && p.tipo_precio.includes('MAYOR')))
                        );

                        if (index !== -1) {
                            csvPreview[index].precio_neto = precioDrive.neto;
                            csvPreview[index].precio_bruto = precioDrive.bruto;
                            csvPreview[index].actualizado = true;
                        }
                    });
                }
            });

            // 3. Agregar productos nuevos (con prefijos si tienen)
            cambiosDetectados.forEach(cambio => {
                if (cambio.tipo === 'nuevo') {
                    const skuFinal = prefijosAplicados[cambio.sku] || cambio.sku;
                    
                    cambio.drive.precios.forEach(precio => {
                        csvPreview.push({
                            sku: skuFinal,
                            skuOriginal: cambio.sku,
                            descripcion: cambio.descripcion,
                            tipo_precio: precio.tipo,
                            precio_neto: precio.neto,
                            precio_bruto: precio.bruto,
                            origen: 'nuevo',
                            actualizado: false,
                            tienePrefijo: prefijosAplicados[cambio.sku] ? true : false,
                            sinPrecio: (precio.neto === 0 && precio.bruto === 0)
                        });
                    });
                }
            });

            log(`‚úÖ Vista previa generada: ${csvPreview.length} l√≠neas`, 'success');
            return csvPreview;
        }

        function renderStatsPreview() {
            const total = csvPreview.length;
            const nuevos = csvPreview.filter(p => p.origen === 'nuevo').length;
            const conPrefijo = csvPreview.filter(p => p.tienePrefijo).length;
            const actualizados = csvPreview.filter(p => p.actualizado).length;
            const gitOriginales = csvPreview.filter(p => p.origen === 'git' && !p.actualizado).length;

            ui.statsPreview.innerHTML = `
                <div class="bg-accent text-white p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold">${total}</div>
                    <div class="text-xs">Total L√≠neas</div>
                </div>
                <div class="badge-nuevo text-white p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold">${nuevos}</div>
                    <div class="text-xs">Nuevos</div>
                </div>
                <div class="badge-info text-white p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold">${conPrefijo}</div>
                    <div class="text-xs">Con Prefijo</div>
                </div>
                <div class="badge-actualizado text-white p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold">${actualizados}</div>
                    <div class="text-xs">Actualizados</div>
                </div>
                <div class="bg-gray-600 text-white p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold">${gitOriginales}</div>
                    <div class="text-xs">Git Sin Cambio</div>
                </div>
            `;
        }

        function renderPreview(filtro = 'todos', busqueda = '') {
            let previewFiltrado = csvPreview;

            // Filtro por tipo
            if (filtro === 'nuevos') {
                previewFiltrado = previewFiltrado.filter(p => p.origen === 'nuevo');
            } else if (filtro === 'git-originales') {
                previewFiltrado = previewFiltrado.filter(p => p.origen === 'git' && !p.actualizado);
            } else if (filtro === 'con-prefijo') {
                previewFiltrado = previewFiltrado.filter(p => p.tienePrefijo);
            }

            // Filtro por b√∫squeda
            if (busqueda) {
                const termino = busqueda.toLowerCase();
                previewFiltrado = previewFiltrado.filter(p => 
                    p.sku.toLowerCase().includes(termino) ||
                    (p.skuOriginal && p.skuOriginal.toLowerCase().includes(termino))
                );
            }

            const formatter = new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                maximumFractionDigits: 0
            });

            // Agrupar por SKU para mostrar
            const productosPorSku = {};
            previewFiltrado.forEach(linea => {
                if (!productosPorSku[linea.sku]) {
                    productosPorSku[linea.sku] = {
                        sku: linea.sku,
                        skuOriginal: linea.skuOriginal,
                        descripcion: linea.descripcion,
                        origen: linea.origen,
                        tienePrefijo: linea.tienePrefijo,
                        actualizado: linea.actualizado,
                        sinPrecio: linea.sinPrecio,
                        precios: []
                    };
                }
                productosPorSku[linea.sku].precios.push({
                    tipo: linea.tipo_precio,
                    neto: linea.precio_neto,
                    bruto: linea.precio_bruto
                });
            });

            let html = '<div class="space-y-2">';
            Object.values(productosPorSku).forEach(producto => {
                const esNuevo = producto.origen === 'nuevo';
                const puedeEditarPrefijo = esNuevo;
                const borderColor = producto.tienePrefijo ? 'border-purple-500' : 
                                   esNuevo ? 'border-green-500' : 
                                   producto.actualizado ? 'border-blue-500' : 'border-gray-600';

                html += `
                    <div class="bg-accent p-3 rounded-lg border-l-4 ${borderColor} ${puedeEditarPrefijo ? 'cursor-pointer hover:bg-opacity-80' : ''}"
                         ${puedeEditarPrefijo ? `onclick="abrirModalPrefijo('${producto.skuOriginal || producto.sku}')"` : ''}>
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                ${esNuevo ? '<span class="badge-nuevo text-white text-xs px-2 py-1 rounded font-semibold mr-2">NUEVO</span>' : ''}
                                ${producto.actualizado ? '<span class="badge-actualizado text-white text-xs px-2 py-1 rounded font-semibold mr-2">ACTUALIZADO</span>' : ''}
                                
                                ${producto.tienePrefijo ? `
                                    <div class="mt-1">
                                        <span class="text-xs text-secondary">Original:</span>
                                        <span class="text-xs text-gray-400 line-through">${producto.skuOriginal}</span>
                                        <span class="text-xs text-secondary mx-2">‚Üí</span>
                                        <span class="font-bold text-lg text-purple-300">${producto.sku}</span>
                                        <span class="ml-2 text-xs bg-purple-600 text-white px-2 py-1 rounded">CON PREFIJO</span>
                                    </div>
                                ` : `
                                    <span class="font-bold text-lg ${esNuevo ? 'text-green-300' : 'text-blue-300'}">${producto.sku}</span>
                                `}
                                
                                ${puedeEditarPrefijo ? '<span class="ml-2 text-xs text-yellow-400">üëÜ Click para agregar prefijo</span>' : ''}
                            </div>
                        </div>
                        
                        <div class="text-sm mb-2">${producto.descripcion}</div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                            ${producto.precios.map(p => `
                                <div class="bg-primary p-2 rounded ${p.neto === 0 && p.bruto === 0 ? 'border border-orange-500' : ''}">
                                    <div class="font-semibold text-purple-400">${p.tipo}</div>
                                    <div class="${p.neto > 0 ? '' : 'text-orange-400'}">Neto: ${p.neto > 0 ? formatter.format(p.neto) : 'SIN PRECIO'}</div>
                                    <div class="${p.bruto > 0 ? '' : 'text-orange-400'}">Bruto: ${p.bruto > 0 ? formatter.format(p.bruto) : 'SIN PRECIO'}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            ui.listaPreview.innerHTML = Object.keys(productosPorSku).length > 0 ? 
                html : 
                '<p class="text-secondary text-center py-8">No hay productos que mostrar con este filtro</p>';
        }

        // ========== MODAL DE PREFIJOS ==========
        // ========== MODAL DE PREFIJOS ==========
        function abrirModalPrefijo(skuOriginal) {
            const cambio = cambiosDetectados.find(c => c.sku === skuOriginal);
            if (!cambio) return;

            skuModalActual = skuOriginal;
            ui.modalSkuOriginal.textContent = skuOriginal;
            ui.modalDescripcion.textContent = cambio.descripcion;
            
            const prefijoActual = prefijosAplicados[skuOriginal];
            if (prefijoActual) {
                ui.inputPrefijo.value = prefijoActual.replace(skuOriginal, '');
                ui.previewSkuFinal.textContent = prefijoActual;
            } else {
                ui.inputPrefijo.value = '';
                ui.previewSkuFinal.textContent = skuOriginal;
            }

            ui.modalPrefijo.style.display = 'flex';
        }

        function cerrarModalPrefijo() {
            ui.modalPrefijo.style.display = 'none';
            skuModalActual = null;
        }

        function aplicarPrefijoModal() {
            if (!skuModalActual) return;

            const prefijo = ui.inputPrefijo.value.trim().toUpperCase();
            
            if (prefijo) {
                prefijosAplicados[skuModalActual] = prefijo + skuModalActual;
                log(`‚úÖ Prefijo aplicado: ${skuModalActual} ‚Üí ${prefijosAplicados[skuModalActual]}`, 'success');
            } else {
                delete prefijosAplicados[skuModalActual];
                log(`üóëÔ∏è Prefijo eliminado: ${skuModalActual}`, 'info');
            }

            generarVistaPrevia();
            renderStatsPreview();
            renderPreview(filtroPreview, ui.buscarPreview.value);
            cerrarModalPrefijo();
        }

        function quitarPrefijoModal() {
            if (!skuModalActual) return;

            delete prefijosAplicados[skuModalActual];
            log(`üóëÔ∏è Prefijo eliminado: ${skuModalActual}`, 'info');

            generarVistaPrevia();
            renderStatsPreview();
            renderPreview(filtroPreview, ui.buscarPreview.value);
            cerrarModalPrefijo();
        }

        function limpiarTodosPrefijos() {
            if (Object.keys(prefijosAplicados).length === 0) {
                alert('No hay prefijos para limpiar');
                return;
            }

            if (confirm(`¬øSeguro que quieres eliminar TODOS los prefijos (${Object.keys(prefijosAplicados).length})?`)) {
                prefijosAplicados = {};
                log('üóëÔ∏è Todos los prefijos eliminados', 'info');
                
                generarVistaPrevia();
                renderStatsPreview();
                renderPreview(filtroPreview, ui.buscarPreview.value);
            }
        }

        function abrirModalMasivo() {
            ui.inputPrefijoMasivo.value = '';
            
            // Listar solo productos NUEVOS
            const nuevos = cambiosDetectados.filter(c => c.tipo === 'nuevo');
            
            let html = '<div class="space-y-1">';
            nuevos.forEach(producto => {
                const tienePrefijo = prefijosAplicados[producto.sku];
                html += `
                    <label class="flex items-center p-2 hover:bg-primary rounded cursor-pointer">
                        <input type="checkbox" class="h-4 w-4 rounded mr-3" value="${producto.sku}">
                        <div class="flex-1">
                            <div class="font-semibold text-sm ${tienePrefijo ? 'text-purple-300' : 'text-blue-300'}">
                                ${tienePrefijo ? prefijosAplicados[producto.sku] : producto.sku}
                                ${tienePrefijo ? `<span class="text-xs text-gray-400 ml-2">(${producto.sku})</span>` : ''}
                            </div>
                            <div class="text-xs text-secondary">${producto.descripcion}</div>
                        </div>
                    </label>
                `;
            });
            html += '</div>';
            
            ui.listaProductosMasivo.innerHTML = html;
            ui.modalPrefijoMasivo.style.display = 'flex';
        }

        function cerrarModalMasivo() {
            ui.modalPrefijoMasivo.style.display = 'none';
        }

        function aplicarPrefijoMasivo() {
            const prefijo = ui.inputPrefijoMasivo.value.trim().toUpperCase();
            
            if (!prefijo) {
                alert('Debes escribir un prefijo');
                return;
            }

            const checkboxes = ui.listaProductosMasivo.querySelectorAll('input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert('Debes seleccionar al menos un producto');
                return;
            }

            let count = 0;
            checkboxes.forEach(checkbox => {
                const sku = checkbox.value;
                prefijosAplicados[sku] = prefijo + sku;
                count++;
            });

            log(`‚úÖ Prefijo "${prefijo}" aplicado a ${count} producto(s)`, 'success');

            generarVistaPrevia();
            renderStatsPreview();
            renderPreview(filtroPreview, ui.buscarPreview.value);
            cerrarModalMasivo();
        }

        function generarCSVActualizado() {
            log('Generando cat√°logo actualizado desde vista previa...', 'info');
            
            if (csvPreview.length === 0) {
                alert('Error: No hay vista previa generada');
                return;
            }

            // Generar CSV con estructura Git EXACTA desde csvPreview
            let csvTexto = 'SKU;DESCRIPCION;TIPO_PRECIO;PRECIO_NETO;PRECIO_BRUTO\n';
            csvPreview.forEach(producto => {
                const linea = [
                    producto.sku,
                    `"${producto.descripcion.replace(/"/g, '""')}"`,
                    producto.tipo_precio,
                    producto.precio_neto || 0,
                    producto.precio_bruto || 0
                ].join(';');
                csvTexto += linea + '\n';
            });

            // Descargar archivo
            const blob = new Blob([csvTexto], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const fecha = new Date().toISOString().split('T')[0].replace(/-/g, '');
            
            link.setAttribute('href', url);
            link.setAttribute('download', `GIT${fecha}CATALOGO_ACTUALIZADO.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            log(`‚úÖ CSV generado: GIT${fecha}CATALOGO_ACTUALIZADO.csv`, 'success');
            log(`üìä Total de l√≠neas: ${csvPreview.length}`, 'info');
            log(`üè∑Ô∏è Productos con prefijo: ${Object.keys(prefijosAplicados).length}`, 'info');
            
            // Mostrar estad√≠sticas finales
            const nuevos = csvPreview.filter(p => p.origen === 'nuevo').length;
            const actualizados = csvPreview.filter(p => p.actualizado).length;
            const conPrefijo = csvPreview.filter(p => p.tienePrefijo).length;
            
            ui.estadisticasFinales.innerHTML = `
                <div class="text-sm font-semibold mb-2">‚úÖ Cat√°logo Generado Exitosamente</div>
                <div class="text-xs space-y-1">
                    <div>üì¶ Total l√≠neas en cat√°logo: ${csvPreview.length}</div>
                    <div>üÜï Nuevas l√≠neas agregadas: ${nuevos}</div>
                    <div>üîÑ L√≠neas con precios actualizados: ${actualizados}</div>
                    <div>üè∑Ô∏è Productos con prefijo aplicado: ${conPrefijo}</div>
                    <div>‚úì Formato: Compatible con Corrector de Pedidos</div>
                    <div>‚úì Delimitador: ; (punto y coma)</div>
                    <div>‚úì Estructura: SKU;DESCRIPCION;TIPO_PRECIO;PRECIO_NETO;PRECIO_BRUTO</div>
                </div>
            `;
        }

        // ========== EVENT LISTENERS ==========
        ui.fileGit.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                Papa.parse(file, {
                    delimiter: ';',
                    skipEmptyLines: true,
                    complete: (results) => {
                        catalogoGit = procesarCatalogoGit(results.data);
                        verificarHabilitarAnalisis();
                    }
                });
            }
        });

        ui.fileDrive.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                Papa.parse(file, {
                    skipEmptyLines: true,
                    complete: (results) => {
                        catalogoDrive = procesarCatalogoDrive(results.data);
                        verificarHabilitarAnalisis();
                    }
                });
            }
        });

        function verificarHabilitarAnalisis() {
            if (catalogoGit.length > 0 && catalogoDrive.length > 0) {
                ui.btnAnalizar.disabled = false;
            }
        }

        ui.btnAnalizar.addEventListener('click', () => {
            // Paso 1: Analizar diferencias
            cambiosDetectados = analizarDiferencias();
            
            // Paso 2: Validar
            erroresDetectados = validarCatalogos();
            renderResumenValidacion();
            renderErrores(tabErrorActiva);
            ui.panelValidacion.classList.remove('hidden');
            
            // Paso 3: Mostrar cambios
            renderResumenCambios();
            renderCambios(filtroActivo);
            ui.panelCambios.classList.remove('hidden');
            
            // Paso 4: Generar vista previa
            generarVistaPrevia();
            renderStatsPreview();
            renderPreview(filtroPreview);
            ui.panelPreview.classList.remove('hidden');
            
            // Paso 5: Habilitar generaci√≥n
            ui.panelGenerar.classList.remove('hidden');
            
            // Scroll suave al resultado
            setTimeout(() => {
                ui.panelValidacion.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 200);
        });

        ui.btnGenerar.addEventListener('click', generarCSVActualizado);

        // Tabs de errores
        document.querySelectorAll('.tab-error').forEach(tab => {
            tab.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-error').forEach(t => {
                    t.classList.remove('active');
                    t.style.backgroundColor = 'rgba(66, 153, 225, 0.2)';
                });
                e.target.classList.add('active');
                e.target.style.backgroundColor = 'var(--accent-blue)';
                
                tabErrorActiva = e.target.dataset.tipo;
                renderErrores(tabErrorActiva);
            });
        });

        // Filtros de cambios
        document.querySelectorAll('.filtro-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filtro-btn').forEach(b => {
                    b.classList.remove('font-semibold', 'bg-blue-600');
                });
                e.target.classList.add('font-semibold', 'bg-blue-600');
                
                filtroActivo = e.target.dataset.tipo;
                renderCambios(filtroActivo, ui.buscarCambios.value);
            });
        });

        ui.buscarCambios.addEventListener('input', (e) => {
            renderCambios(filtroActivo, e.target.value);
        });

        // Filtros de vista previa
        document.querySelectorAll('.filtro-preview').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filtro-preview').forEach(b => {
                    b.classList.remove('font-semibold', 'bg-blue-600');
                });
                e.target.classList.add('font-semibold', 'bg-blue-600');
                
                filtroPreview = e.target.dataset.tipo;
                renderPreview(filtroPreview, ui.buscarPreview.value);
            });
        });

        ui.buscarPreview.addEventListener('input', (e) => {
            renderPreview(filtroPreview, e.target.value);
        });

        // Botones de prefijos
        ui.btnLimpiarPrefijos.addEventListener('click', limpiarTodosPrefijos);
        ui.btnAplicarPrefijoMasivo.addEventListener('click', abrirModalMasivo);

        // Modal prefijo individual
        ui.modalPrefijoClose.addEventListener('click', cerrarModalPrefijo);
        ui.btnAplicarPrefijoModal.addEventListener('click', aplicarPrefijoModal);
        ui.btnQuitarPrefijoModal.addEventListener('click', quitarPrefijoModal);
        
        ui.inputPrefijo.addEventListener('input', (e) => {
            const prefijo = e.target.value.trim().toUpperCase();
            if (skuModalActual) {
                ui.previewSkuFinal.textContent = prefijo ? (prefijo + skuModalActual) : skuModalActual;
            }
        });

        // Modal prefijo masivo
        ui.modalMasivoClose.addEventListener('click', cerrarModalMasivo);
        ui.btnAplicarMasivo.addEventListener('click', aplicarPrefijoMasivo);

        // Cerrar modales al hacer click fuera
        window.addEventListener('click', (e) => {
            if (e.target === ui.modalPrefijo) {
                cerrarModalPrefijo();
            }
            if (e.target === ui.modalPrefijoMasivo) {
                cerrarModalMasivo();
            }
        });

        // Inicializaci√≥n
        log('‚úÖ Sistema de sincronizaci√≥n inteligente listo', 'success');
        log('üìã Carga ambos archivos para comenzar', 'info');
    </script>
</body>
</html>
